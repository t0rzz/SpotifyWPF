<UserControl x:Class="SpotifyWPF.View.Page.AlbumsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:view="clr-namespace:SpotifyWPF.View"
             xmlns:conv="clr-namespace:SpotifyWPF.View.Converters"
             mc:Ignorable="d"
             DataContext="{Binding AlbumsPage, Source={StaticResource Locator}}"
             d:DesignHeight="450" d:DesignWidth="800">

    <UserControl.Resources>
        <conv:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <conv:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <ContextMenu x:Key="AlbumsContextMenu" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource ControlBorderBrush}" BorderThickness="1" Padding="4" OverridesDefaultStyle="True" FocusVisualStyle="{x:Null}">
            <ContextMenu.Template>
                <ControlTemplate TargetType="ContextMenu">
                    <Border Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            Padding="{TemplateBinding Padding}"
                            SnapsToDevicePixels="True">
                        <ItemsPresenter />
                    </Border>
                </ControlTemplate>
            </ContextMenu.Template>
            <ContextMenu.Resources>
                <Style x:Key="MenuItemPlain" TargetType="MenuItem" BasedOn="{x:Null}">
                    <Setter Property="OverridesDefaultStyle" Value="True"/>
                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="{DynamicResource ControlForegroundBrush}"/>
                    <Setter Property="Padding" Value="8,6"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="MenuItem">
                                <Border x:Name="Border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter ContentSource="Header"
                                                      RecognizesAccessKey="True"
                                                      VerticalAlignment="Center"
                                                      TextBlock.Foreground="{Binding Foreground, RelativeSource={RelativeSource TemplatedParent}}"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsHighlighted" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource ControlHighlightBrush}"/>
                                        <Setter Property="Foreground" Value="{DynamicResource ControlHighlightForegroundBrush}"/>
                                    </Trigger>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Opacity" Value="0.6"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
                <Style TargetType="MenuItem" BasedOn="{StaticResource MenuItemPlain}"/>
            </ContextMenu.Resources>

            <MenuItem Header="Open in Spotify"
                      Command="{Binding PlacementTarget.Tag.OpenInSpotifyCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=SelectedItems.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=single}"/>
            <MenuItem Header="Copy Link"
                      Command="{Binding PlacementTarget.Tag.CopyAlbumLinkCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=SelectedItems.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=single}"/>
            <Separator Visibility="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=SelectedItems.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=multiple}"/>
            <MenuItem Header="Remove from Library"
                      Foreground="{DynamicResource DangerBrush}"
                      Command="{Binding PlacementTarget.Tag.RemoveAlbumCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=SelectedItems.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=single}"/>
            <MenuItem Header="Remove from Library"
                      Foreground="{DynamicResource DangerBrush}"
                      Command="{Binding PlacementTarget.Tag.DeleteSelectedAlbumsFromContextMenuCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding RelativeSource={RelativeSource AncestorType=DataGrid}, Path=SelectedItems.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=multiple}"/>
        </ContextMenu>
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding Key="F5" Command="{Binding LoadAlbumsCommand}" />
    </UserControl.InputBindings>

    <DockPanel LastChildFill="True">
        <!-- Greeting header -->
        <Border DockPanel.Dock="Top" Margin="8,8,8,0" Background="Transparent">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <Ellipse Width="28" Height="28" StrokeThickness="0.5" Stroke="{DynamicResource ControlBorderBrush}">
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="{Binding ProfileImagePath}" Stretch="UniformToFill"/>
                    </Ellipse.Fill>
                </Ellipse>
                <TextBlock Text="{Binding GreetingText}" FontSize="16" FontWeight="SemiBold" Margin="8,0,0,0"/>
            </StackPanel>
        </Border>

        <!-- Toolbar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8,8,8,0">
            <Button Content="Load Albums" Command="{Binding LoadAlbumsCommand}" Margin="0,0,8,0"/>
            <Button Content="Remove Selected" Command="{Binding DeleteSelectedAlbumsCommand}"
                    Background="{DynamicResource DangerBrush}" Foreground="White"
                    CommandParameter="{Binding ElementName=AlbumsDataGrid, Path=SelectedItems}"/>
        </StackPanel>

        <!-- Progress bar -->
        <Border DockPanel.Dock="Top" Margin="8" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource ControlBorderBrush}" BorderThickness="1" Visibility="{Binding ProgressVisibility}">
            <StackPanel Margin="8">
                <TextBlock Text="{Binding Status}" FontWeight="SemiBold"/>
                <ProgressBar Height="4" IsIndeterminate="True" Margin="0,4,0,0"/>
            </StackPanel>
        </Border>

        <!-- Albums GroupBox -->
        <GroupBox Header="Albums" Margin="8">
            <DockPanel>
                <!-- Search Panel for Albums -->
                <Border DockPanel.Dock="Top" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Margin="0,0,0,8">
                    <Grid Margin="8,6">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Search Icon -->
                        <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,8,0">
                            <Path Fill="{DynamicResource ControlForegroundBrush}" Opacity="0.6"
                                  Data="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </Viewbox>

                        <!-- Search TextBox -->
                        <TextBox Grid.Column="1" x:Name="AlbumsSearchTextBox"
                                 Text="{Binding AlbumsFilterText, UpdateSourceTrigger=PropertyChanged}"
                                 Background="Transparent" BorderThickness="0"
                                 Foreground="{DynamicResource ControlForegroundBrush}"
                                 FontSize="12" Padding="0"
                                 VerticalContentAlignment="Center"
                                 Tag="Filter albums by name or artist...">
                            <TextBox.Style>
                                <Style TargetType="TextBox">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="TextBox">
                                                <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ScrollViewer x:Name="PART_ContentHost"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="Text" Value="">
                                            <Setter Property="Foreground" Value="{DynamicResource ControlForegroundBrush}"/>
                                            <Setter Property="Opacity" Value="0.6"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBox.Style>
                        </TextBox>
                    </Grid>
                </Border>

                <!-- Albums DataGrid -->
                <DataGrid x:Name="AlbumsDataGrid" ItemsSource="{Binding FilteredAlbums}" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True" Height="300"
                          SelectionChanged="AlbumsDataGrid_SelectionChanged">
                    <DataGrid.InputBindings>
                        <MouseBinding Gesture="LeftDoubleClick"
                                      Command="{Binding OpenInSpotifyCommand}"
                                      CommandParameter="{Binding ElementName=AlbumsDataGrid, Path=SelectedItem}"/>
                        <KeyBinding Key="Delete"
                                    Command="{Binding DeleteSelectedAlbumsCommand}"
                                    CommandParameter="{Binding ElementName=AlbumsDataGrid, Path=SelectedItems}"/>
                    </DataGrid.InputBindings>

                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                            <Setter Property="ContextMenu" Value="{StaticResource AlbumsContextMenu}"/>
                        </Style>
                    </DataGrid.RowStyle>

                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Cover" Width="60">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Image Source="{Binding ImageUrl}" Width="50" Height="50" Stretch="UniformToFill"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="2*"/>
                        <DataGridTextColumn Header="Artist" Binding="{Binding Artist}" Width="*"/>
                        <DataGridTextColumn Header="# Tracks" Binding="{Binding TotalTracks}" Width="80"/>
                        <DataGridTextColumn Header="Added" Binding="{Binding AddedAt, StringFormat=d}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </GroupBox>

        <!-- Load More Button -->
        <Button DockPanel.Dock="Bottom" Content="Load More Albums" Command="{Binding LoadMoreAlbumsCommand}"
                HorizontalAlignment="Center" Margin="8" Padding="12,6"
                Visibility="Collapsed"/>
    </DockPanel>
</UserControl>