<Window x:Class="SpotifyWPF.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"        
        xmlns:local="clr-namespace:SpotifyWPF.Views"
        xmlns:view="clr-namespace:SpotifyWPF.View"
        xmlns:vm="clr-namespace:SpotifyWPF.ViewModel"
        xmlns:page="clr-namespace:SpotifyWPF.View.Page"
        xmlns:vm1="clr-namespace:SpotifyWPF.ViewModel.Page"
        xmlns:component="clr-namespace:SpotifyWPF.ViewModel.Component"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        mc:Ignorable="d"
        Title="" Height="800" Width="1100" WindowStartupLocation="CenterScreen" WindowState="Maximized"
        Background="{DynamicResource AppBackgroundBrush}" FontFamily="Segoe UI" FontSize="13" SnapsToDevicePixels="True" UseLayoutRounding="True"
        SizeChanged="Window_SizeChanged"
        DataContext="{Binding Main, Source={StaticResource Locator}}">

    <Window.Resources>
        <DataTemplate DataType="{x:Type vm1:LoginPageViewModel}">
            <page:LoginPage/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm1:PlaylistsPageViewModel}">
            <page:PlaylistsPage/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm1:SearchPageViewModel}">
            <page:SearchPage/>
        </DataTemplate>

        <!-- Modern Player Styles -->
        <SolidColorBrush x:Key="PlayerBackgroundBrush" Color="#181818"/>
        <SolidColorBrush x:Key="PlayerAccentBrush" Color="#1DB954"/>
        <SolidColorBrush x:Key="PlayerPrimaryTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="PlayerSecondaryTextBrush" Color="#B3B3B3"/>
        
        <!-- Play Button Style -->
        <Style x:Key="PlayButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="72"/>
            <Setter Property="Height" Value="72"/>
            <Setter Property="Background" Value="{StaticResource PlayerAccentBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="36">
                            <ContentPresenter HorizontalAlignment="Center" 
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Opacity" Value="0.8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Control Button Style -->
        <Style x:Key="ControlButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PlayerPrimaryTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" 
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.8"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Shuffle button highlights green when shuffle is ON -->
        <Style x:Key="ShuffleButtonStyle" TargetType="Button" BasedOn="{StaticResource ControlButtonStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Player.IsShuffled}" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource PlayerAccentBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Repeat button highlights green when repeat is context or track -->
        <Style x:Key="RepeatButtonStyle" TargetType="Button" BasedOn="{StaticResource ControlButtonStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Player.RepeatMode}" Value="1">
                    <Setter Property="Foreground" Value="{StaticResource PlayerAccentBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Player.RepeatMode}" Value="2">
                    <Setter Property="Foreground" Value="{StaticResource PlayerAccentBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Modern Slider Style -->
        <Style x:Key="ModernSliderStyle" TargetType="Slider">
            <Setter Property="Height" Value="6"/>
            <Setter Property="Background" Value="#535353"/>
            <Setter Property="Foreground" Value="{StaticResource PlayerAccentBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid>
                            <Border Background="{TemplateBinding Background}"
                                    Height="6" CornerRadius="3"/>
                            <Track x:Name="PART_Track"
                                   Minimum="{TemplateBinding Minimum}"
                                   Maximum="{TemplateBinding Maximum}"
                                   Value="{TemplateBinding Value}"
                                   Orientation="{TemplateBinding Orientation}"
                                   IsDirectionReversed="{TemplateBinding IsDirectionReversed}">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Background="{TemplateBinding Foreground}" 
                                                  BorderThickness="0" 
                                                  Height="6" 
                                                  Template="{x:Null}"/>
                                </Track.DecreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Width="18" Height="18" 
                                           Background="{TemplateBinding Foreground}"
                                           BorderThickness="0"
                                           Margin="0,-6,0,-6">
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="Thumb">
                                                <Ellipse Fill="{TemplateBinding Background}"
                                                         Width="18" Height="18"/>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Background="Transparent" 
                                                  BorderThickness="0" 
                                                  Template="{x:Null}"/>
                                </Track.IncreaseRepeatButton>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Track Card Style -->
        <Style x:Key="TrackCardStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Margin" Value="12"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Menu -->
            <RowDefinition Height="*"/>   <!-- Scrollable content -->
            <RowDefinition Height="40"/> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" ItemsSource="{Binding MenuItems}">
            <Menu.ItemContainerStyle>
                <Style TargetType="{x:Type MenuItem}">
                    <Setter Property="Command" Value="{Binding Command}"/>
                    <Setter Property="CommandParameter" Value="{Binding}"/>
                    <Setter Property="IsChecked" Value="{Binding IsChecked}"/>
                    <Setter Property="Foreground" Value="{DynamicResource ControlForegroundBrush}"/>
                    <EventSetter Event="SubmenuOpened" Handler="MenuItem_SubmenuOpened"/>
                    <EventSetter Event="MouseEnter" Handler="MenuItem_MouseEnter"/>
                    <Style.Triggers>
                        <Trigger Property="Role" Value="TopLevelHeader">
                            <Setter Property="Foreground" Value="{DynamicResource ControlForegroundBrush}"/>
                        </Trigger>
                        <Trigger Property="Role" Value="TopLevelItem">
                            <Setter Property="Foreground" Value="{DynamicResource ControlForegroundBrush}"/>
                        </Trigger>
                        <Trigger Property="Role" Value="SubmenuItem">
                            <Setter Property="Foreground" Value="#222222"/>
                        </Trigger>
                        <Trigger Property="Role" Value="SubmenuHeader">
                            <Setter Property="Foreground" Value="#222222"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Menu.ItemContainerStyle>

            <Menu.ItemTemplate>
                <HierarchicalDataTemplate DataType="{x:Type component:MenuItemViewModel}" ItemsSource="{Binding Path=MenuItems}">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Header}"
                                   VerticalAlignment="Center"
                                   Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=MenuItem}}"/>
                        <TextBlock Text="{Binding IconGlyph}"
                                   FontFamily="Segoe MDL2 Assets"
                                   Margin="6,0,0,0"
                                   VerticalAlignment="Center"
                                   Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=MenuItem}}"/>
                    </StackPanel>
                </HierarchicalDataTemplate>
            </Menu.ItemTemplate>
        </Menu>

        <!-- Scrollable content area: pages + top tracks + player -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" CanContentScroll="False" PanningMode="VerticalFirst">
            <StackPanel>
                <!-- Main Content Pages -->
                <ContentControl x:Name="Pages" Content="{Binding CurrentPage}"/>

                <!-- Top Tracks Area -->
                <Border Background="{StaticResource PlayerBackgroundBrush}" 
                        BorderThickness="0,1,0,0" BorderBrush="#333333">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Top Tracks Header -->
                        <TextBlock Grid.Row="0" Text="Top Tracks" 
                                   FontSize="20" FontWeight="SemiBold" 
                                   Foreground="{StaticResource PlayerPrimaryTextBrush}"
                                   Margin="24,16,24,12"/>
                        
                        <!-- Top Tracks Horizontal Scroll -->
                        <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled"
                                      Margin="12,0,12,12" PanningMode="HorizontalOnly">
                            <ItemsControl ItemsSource="{Binding Player.TopTracks}" x:Name="TopTracksPanel"
                                          HorizontalAlignment="Left">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Style="{StaticResource TrackCardStyle}"
                                                Command="{Binding DataContext.Player.ClickTrackCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                AutomationProperties.Name="{Binding Title}"
                                                Margin="0,0,16,0">
                                            <StackPanel Width="160">
                                                <!-- Album Art -->
                                                <Border Width="160" Height="160" CornerRadius="12"
                                                        Background="#181818">
                                                    <Border.Effect>
                                                        <DropShadowEffect ShadowDepth="2" BlurRadius="8" 
                                                                          Opacity="0.3" Color="Black"/>
                                                    </Border.Effect>
                                                    <Image Source="{Binding AlbumArtUri}" 
                                                           Stretch="UniformToFill">
                                                        <Image.Clip>
                                                            <RectangleGeometry Rect="0,0,160,160" RadiusX="12" RadiusY="12"/>
                                                        </Image.Clip>
                                                    </Image>
                                                </Border>
                                                
                                                <!-- Track Info -->
                                                <TextBlock Text="{Binding Title}" 
                                                           FontSize="18" FontWeight="SemiBold"
                                                           Foreground="{StaticResource PlayerPrimaryTextBrush}"
                                                           Margin="0,8,0,4" TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding Artist}" 
                                                           FontSize="12"
                                                           Foreground="{StaticResource PlayerSecondaryTextBrush}"
                                                           TextTrimming="CharacterEllipsis"/>
                                            </StackPanel>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>

                <!-- Player Area -->
                <Border Background="{StaticResource PlayerBackgroundBrush}" 
                        BorderThickness="0,1,0,0" BorderBrush="#333333">
                    <Grid Margin="24,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/> <!-- Album Art -->
                            <ColumnDefinition Width="*"/>    <!-- Info & Controls -->
                        </Grid.ColumnDefinitions>

                        <!-- Album Art -->
                        <Border Grid.Column="0" x:Name="AlbumArtBorder"
                                Width="180" Height="180" CornerRadius="16"
                                Background="#181818" Margin="0,0,24,0">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="3" BlurRadius="12" 
                                                  Opacity="0.4" Color="Black"/>
                            </Border.Effect>
                            <Image Source="{Binding Player.CurrentTrack.AlbumArtUri}" 
                                   Stretch="UniformToFill">
                                <Image.Clip>
                                    <RectangleGeometry Rect="0,0,180,180" RadiusX="16" RadiusY="16"/>
                                </Image.Clip>
                            </Image>
                        </Border>

                        <!-- Info & Controls -->
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <!-- Track Info -->
                            <TextBlock x:Name="TrackTitleText"
                                       Text="{Binding Player.CurrentTrack.Title}" 
                                       FontSize="34" FontWeight="SemiBold"
                                       Foreground="{StaticResource PlayerPrimaryTextBrush}"
                                       Margin="0,0,0,8" TextTrimming="CharacterEllipsis"/>
                            <TextBlock Text="{Binding Player.CurrentTrack.Artist}" 
                                       FontSize="16"
                                       Foreground="{StaticResource PlayerSecondaryTextBrush}"
                                       Margin="0,0,0,16" TextTrimming="CharacterEllipsis"/>

                            <!-- Progress Slider -->
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Grid.Column="0" x:Name="CurrentTimeText"
                                           Text="{Binding Player.PositionMs, Converter={x:Static local:TimeConverter.Instance}}" 
                                           FontSize="12" 
                                           Foreground="{StaticResource PlayerSecondaryTextBrush}"
                                           Margin="0,0,12,0" VerticalAlignment="Center"/>
                                
                                <Slider Grid.Column="1" x:Name="PositionSlider"
                                        Style="{StaticResource ModernSliderStyle}"
                                        Minimum="0" 
                                        Maximum="{Binding Player.CurrentTrack.DurationMs}"
                                        Value="{Binding Player.PositionMs, Mode=TwoWay}"
                                        PreviewMouseLeftButtonDown="PositionSlider_PreviewMouseLeftButtonDown"
                                        PreviewMouseLeftButtonUp="PositionSlider_PreviewMouseLeftButtonUp"
                                        ValueChanged="PositionSlider_ValueChanged"
                                        AutomationProperties.Name="Track Position"/>
                                
                                <TextBlock Grid.Column="2" x:Name="TotalTimeText"
                                           Text="{Binding Player.CurrentTrack.DurationMs, Converter={x:Static local:TimeConverter.Instance}}" 
                                           FontSize="12" 
                                           Foreground="{StaticResource PlayerSecondaryTextBrush}"
                                           Margin="12,0,0,0" VerticalAlignment="Center"/>
                            </Grid>

                            <!-- Controls -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <!-- Shuffle -->
                                <Button Style="{StaticResource ShuffleButtonStyle}" 
                                        Width="40" Height="40" Margin="0,0,8,0"
                                        Command="{Binding Player.ToggleShuffleCommand}"
                                        AutomationProperties.Name="Shuffle">
                                    <TextBlock Text="&#xE8B1;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                               Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                                </Button>
                                
                                <!-- Previous -->
                                <Button Style="{StaticResource ControlButtonStyle}" 
                                        Width="48" Height="48" Margin="0,0,8,0"
                                        Command="{Binding Player.PrevCommand}"
                                        AutomationProperties.Name="Previous Track">
                                    <TextBlock Text="&#xE892;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                                </Button>
                                
                                <!-- Play/Pause -->
                                <Button Style="{StaticResource PlayButtonStyle}" 
                                        Command="{Binding Player.PlayPauseCommand}"
                                        Margin="0,0,8,0"
                                        AutomationProperties.Name="{Binding Player.IsPlaying, Converter={x:Static local:PlayPauseAccessibilityConverter.Instance}}">
                                    <TextBlock FontFamily="Segoe MDL2 Assets" FontSize="36">
                                        <TextBlock.Text>
                                            <Binding Path="Player.IsPlaying">
                                                <Binding.Converter>
                                                    <local:PlayPauseIconConverter/>
                                                </Binding.Converter>
                                            </Binding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </Button>
                                
                                <!-- Next -->
                                <Button Style="{StaticResource ControlButtonStyle}" 
                                        Width="48" Height="48" Margin="0,0,8,0"
                                        Command="{Binding Player.NextCommand}"
                                        AutomationProperties.Name="Next Track">
                                    <TextBlock Text="&#xE893;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                                </Button>
                                
                                <!-- Repeat -->
                                <Button Style="{StaticResource RepeatButtonStyle}" 
                                        Width="40" Height="40"
                                        Command="{Binding Player.CycleRepeatCommand}"
                                        AutomationProperties.Name="Repeat">
                                    <TextBlock Text="&#xE8EE;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                               Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                                </Button>
                                
                                <!-- Volume -->
                                <StackPanel Orientation="Horizontal" Margin="24,0,0,0" VerticalAlignment="Center">
                                    <TextBlock Text="&#xE767;" FontFamily="Segoe MDL2 Assets" 
                                               FontSize="16" Foreground="{StaticResource PlayerSecondaryTextBrush}"
                                               Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <Slider Style="{StaticResource ModernSliderStyle}"
                        Width="120" Minimum="0" Maximum="1"
                        Value="{Binding Player.Volume, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        PreviewMouseLeftButtonDown="VolumeSlider_PreviewMouseLeftButtonDown"
                        AutomationProperties.Name="Volume"/>
                                </StackPanel>
                                
                                <!-- Refresh -->
                                <Button Style="{StaticResource ControlButtonStyle}" 
                                        Width="40" Height="40" Margin="16,0,0,0"
                                        Command="{Binding Player.RefreshCommand}"
                                        ToolTip="Refresh player state"
                                        AutomationProperties.Name="Refresh">
                                    <TextBlock Text="&#xE72C;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                               Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="#181818" BorderBrush="#333333" BorderThickness="0,1,0,0">
            <view:StatusBar DataContext="{Binding StatusBar, Source={StaticResource Locator}}"/>
        </Border>

        <!-- WebView2 for Web Playback SDK (kept visible so audio isn't suspended). Push behind UI to avoid showing the 1px dot. -->
        <wv2:WebView2 x:Name="WebPlaybackWebView"
                  Width="1" Height="1"
                  IsHitTestVisible="False"
                  Focusable="False"
                  Panel.ZIndex="-1"
                  Grid.Row="0"
                  HorizontalAlignment="Left"
                  VerticalAlignment="Top"
                  Margin="-2,-2,0,0"/>
    </Grid>
</Window>
