name: Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'SpotifyWPF/SpotifyWPF.csproj'
      - 'SpotifyWPF/app.manifest'
      - 'SpotifyWPF.MSIX/Package.appxmanifest'
      - '.github/workflows/release.yml'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and create GitHub Release
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

  # Removed VS component setup to avoid unknown action errors. We'll fallback to manual MakeAppx if Desktop Bridge isn't present.

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Extract version
        id: version
        run: |
          $csproj = Get-Content './SpotifyWPF/SpotifyWPF.csproj'
          $m = Select-String -InputObject $csproj -Pattern '<Version>([^<]+)</Version>' -AllMatches
          if (-not $m.Matches.Success) { Write-Error 'Version element not found in csproj.' }
          $version = $m.Matches[0].Groups[1].Value.Trim()
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "TAG=v$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "tag=v$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Detected version: $version"
        shell: pwsh

      - name: Restore
        run: dotnet restore .\SpotifyWPF.sln
        shell: pwsh

      - name: Build (Release)
        run: dotnet build .\SpotifyWPF\SpotifyWPF.csproj -c Release --no-restore
        shell: pwsh

      - name: Create ZIP of Release binaries
        run: |
          $zipName = "SpotifyWPF-$env:VERSION.zip"
          $src = "${{ github.workspace }}\SpotifyWPF\bin\Release\net8.0-windows\*"
          $dst = "${{ github.workspace }}\$zipName"
          If (Test-Path $dst) { Remove-Item $dst -Force }
          Compress-Archive -Path $src -DestinationPath $dst -Force
          Write-Host "Created archive: $dst"
        shell: pwsh

      - name: Build portable single-file EXE (win-x64)
        run: |
          $out = "${{ github.workspace }}\artifacts\portable\win-x64"
          dotnet publish .\SpotifyWPF\SpotifyWPF.csproj -c Release -r win-x64 -p:PublishSingleFile=true -p:SelfContained=true -p:IncludeNativeLibrariesForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false -o $out
          $exe = Join-Path $out 'SpotifyWPF.exe'
          $dest = "${{ github.workspace }}\SpotifyWPF-$env:VERSION-portable-win-x64.exe"
          Copy-Item $exe $dest -Force
          Write-Host "Portable EXE: $dest"
        shell: pwsh

      - name: Build MSIX (unsigned) via WAP project
        id: msix
        run: |
          $out = "${{ github.workspace }}\artifacts\msix"
          New-Item -ItemType Directory -Force -Path $out | Out-Null
          $msixFinal = $null
          $wapBuilt = $false
          Write-Host 'Attempting WAP build (Desktop Bridge)â€¦'
          try {
            msbuild .\SpotifyWPF.MSIX\SpotifyWPF.MSIX.wapproj /t:Restore,Rebuild /p:Configuration=Release /p:Platform=x64 `
              /p:GenerateAppxPackageOnBuild=true /p:UapAppxPackageBuildMode=SideLoadOnly /p:AppxBundle=Never `
              /p:AppxPackageSigningEnabled=false /p:AppxSymbolPackageEnabled=false /p:AppxPackageDir="$out" | Out-Host
            $wapBuilt = $true
          } catch {
            Write-Warning "WAP build failed: $($_.Exception.Message)"
          }
          $msix = Get-ChildItem $out -Include *.msix,*.appx,*.msixbundle -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $msix) {
            $fallback = Join-Path "${{ github.workspace }}" 'SpotifyWPF.MSIX\AppPackages'
            if (Test-Path $fallback) {
              $msix = Get-ChildItem $fallback -Include *.msix,*.appx,*.msixbundle -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            }
          }
          if ($msix) {
            $msixFinal = $msix.FullName
          } else {
            Write-Host 'No MSIX produced by WAP. Falling back to manual MakeAppx packaging.'
            # Build app binaries first
            dotnet build .\SpotifyWPF\SpotifyWPF.csproj -c Release --no-restore
            $bin = "${{ github.workspace }}\SpotifyWPF\bin\Release\net8.0-windows"
            $stage = Join-Path $env:RUNNER_TEMP 'msix_stage'
            if (Test-Path $stage) { Remove-Item $stage -Recurse -Force }
            New-Item -ItemType Directory -Force -Path $stage | Out-Null
            # Copy app files
            Copy-Item "$bin\*" $stage -Recurse -Force
            # Add assets
            Copy-Item .\SpotifyWPF.MSIX\Images $stage -Recurse -Force
            # Prepare manifest
            [xml]$xml = Get-Content .\SpotifyWPF.MSIX\Package.appxmanifest
            $ver = $env:VERSION
            if ($ver -notmatch '^\d+\.\d+\.\d+\.\d+$') { $ver = "$ver.0" }
            $xml.Package.Identity.Version = $ver
            $appNode = $xml.Package.Applications.Application
            $appNode.Executable = 'SpotifyWPF.exe'
            $appNode.EntryPoint = 'Windows.FullTrustApplication'
            $uapNs = 'http://schemas.microsoft.com/appx/manifest/uap/windows10'
            $nsm = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
            $nsm.AddNamespace('uap',$uapNs)
            $exts = $appNode.SelectSingleNode('uap:Extensions',$nsm)
            if (-not $exts) {
              $exts = $xml.CreateElement('uap','Extensions',$uapNs)
              [void]$appNode.AppendChild($exts)
            }
            $ext = $xml.CreateElement('uap','Extension',$uapNs)
            $null = $ext.SetAttribute('Category','windows.fullTrustProcess')
            $null = $ext.SetAttribute('Executable','SpotifyWPF.exe')
            [void]$exts.AppendChild($ext)
            $manifestPath = Join-Path $stage 'AppxManifest.xml'
            $xml.Save($manifestPath)
            # Locate makeappx
            $makePath = $null
            $kits = 'C:\Program Files (x86)\Windows Kits\10\bin'
            if (Test-Path $kits) {
              $found = Get-ChildItem -Path $kits -Recurse -Filter makeappx.exe -ErrorAction SilentlyContinue | Where-Object { $_.FullName -match '\\x64\\' } | Select-Object -First 1
              if ($found) { $makePath = $found.FullName }
            }
            if (-not $makePath) {
              $cmd = Get-Command makeappx.exe -ErrorAction SilentlyContinue
              if ($cmd) { $makePath = $cmd.Path }
            }
            if (-not $makePath) { Write-Error 'MakeAppx.exe not found on runner.' }
            $dest = "${{ github.workspace }}\SpotifyWPF-$env:VERSION.msix"
            & "$makePath" pack /d "$stage" /p "$dest" /o
            if ($LASTEXITCODE -ne 0 -or -not (Test-Path $dest)) { Write-Error 'MakeAppx packaging failed.' }
            $msixFinal = $dest
          }
          if (-not $msixFinal) { Write-Error 'MSIX package not found.' }
          "MSIX_PATH=$msixFinal" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "MSIX: $msixFinal"
        shell: pwsh

      - name: Upload ZIP and portable EXE
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            ${{ github.workspace }}\SpotifyWPF-${{ steps.version.outputs.version }}.zip
            ${{ github.workspace }}\SpotifyWPF-${{ steps.version.outputs.version }}-portable-win-x64.exe

      - name: Upload MSIX artifact
        if: ${{ steps.msix.outputs.MSIX_PATH != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: release-msix
          path: ${{ steps.msix.outputs.MSIX_PATH }}

      - name: Create GitHub Release (zip + exe)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: SpotifyWPF v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            SpotifyWPF-${{ steps.version.outputs.version }}.zip
            SpotifyWPF-${{ steps.version.outputs.version }}-portable-win-x64.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Attach MSIX to Release (if present)
        if: ${{ steps.msix.outputs.MSIX_PATH != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: ${{ steps.msix.outputs.MSIX_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
